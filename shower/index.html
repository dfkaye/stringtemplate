<!DOCTYPE HTML>
<html lang="en">
<head>
	<title>StringTemplate ~ logic-less templates in JavaScript</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=792, user-scalable=no">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="shower/themes/ribbon/styles/screen.css">
</head>

<body class="list">


	<!--<header class="caption">
		<h1>Shower Presentation Engine</h1>
		<p>Yours Truly, Famous Inc.</p>
	</header>-->
  
  <header class="caption">
		<h1>StringTemplate ~ logic-less templates in JavaScript</h1>
    <p>David Kaye (@dfkaye) <a href="http://github.com/dfkaye">http://github.com/dfkaye</a></p>
		<p>
      Presented at East Bay Modern Web Application Developers meetup,
      October 8, 2014
    </p>
	</header>
  
	<section class="slide cover" id="Cover"><div>
		<h2>Logic-less templates in JavaScript with StringTemplate</h2>
    <p>David Kaye (@dfkaye) <a href="http://github.com/dfkaye">http://github.com/dfkaye</a></p>
		<p>
      Presented at East Bay Modern Web Application Developers meetup,
      October 8, 2014
    </p>
		<img src="pictures/cover.jpg" alt="">
		<!--
			To apply styles to the certain slides
			set slide ID to get needed elements
			-->
		<style>
			#Cover h2 {
				margin:30px 0 0;
				color:#FFF;
				text-align:center;
				font-size:70px;
			}
        
			#Cover p {
				margin:10px 0 0;
				text-align:center;
				color:#FFF;
				font-style:italic;
				font-size:20px;
			}
      
      #Cover p a {
        color:#FFF;
      }
		</style>
	</div></section>
  
  <section class="slide"><div>
		<h2>Contents</h2>
		<ol>
      <li class='next'>Some background</li>
			<li class='next'>Project goals</li>
			<li class='next'>Code samples</li>
			<li class='next'>Challenges</li>
			<li class='next'>Surprises</li>
			<li class='next'>Questions?</li>
		</ol>
	</div></section>


  <section class="slide"><div>
		<h2>Template engines</h2>
    <p>
      Templates are big-ticket features in current MVC JavaScript frameworks
    </p>
		<ol>
			<li>server-side:  jade, ejs, AbsurdJS</li>
			<li>both client &amp; server:  jquery, underscore, mustache, handlebars</li>
			<li>client-side templates tend to emphasize HTML output (escaping)</li>
		</ol>
		<p class="note">Honorable mention for its very small size: riot.js</p>
	</div></section>
  
  <section class="slide" id='HandlebarsMarkup'><div>
		<h2>How they work ~ handlebars sample markup</h2>
    <p>
      Text embedded in custom <b>type</b> (not executed) &lt;script&gt; tags
    </p>
		<pre>
			<code>&lt;script type=<mark>"text/x-handlebars-template"</mark>&gt;</code>
			<code>  &lt;div class="entry"&gt;</code>
      <code>    &lt;h1><mark>{{title}}</mark>&lt;/h1&gt;</code>
      <code>    &lt;div class="body"></code>
      <code>      <mark>{{body}}</mark></code>
      <code>    &lt;/div&gt;</code>
      <code>  &lt;/div&gt;</code>
			<code>&lt;/script&gt;</code>

		</pre>
		<style>
			#HandlebarsMarkup code {
      font-size: 0.8em;
				}
		</style>    
	</div></section>
  
  <section class="slide" id='HandlebarsCode'><div>
		<h2>How they work ~ handlebars sample javascript</h2>
    <p>
      Template text is "compiled" into a "partial" (a function that accepts some
      context or data to be merged with the template, returning new text):
    </p>
		<pre>
      <code>var source   = $("#entry-template").html();</code>
      <code>var template = Handlebars.compile(source);</code>
			<code>var context = {<mark>title</mark>: "My New Post", <mark>body</mark>: "This is my first post!"}</code>
			<code>var html = template(context);</code>
		</pre>
		<style>
			#HandlebarsCode code {
      font-size: 0.8em;
				}
		</style>    
	</div></section>  
  
  <section class="slide" id='HandlebarsOutput'><div>
		<h2>How they work ~ handlebars sample output</h2>
    <p>&hellip;which renders as:</p>
		<pre>
      <code>&lt;div class="entry"&gt;
  &lt;h1&gt;<mark>My New Post</mark>&lt;/h1&gt;
  &lt;div class="body"&gt;
    <mark>This is my first post!</mark>
  &lt;/div&gt;
&lt;/div&gt;
</code>
		</pre>
		<style>
			#HandlebarsOutput code {
      font-size: 0.8em;
				}
		</style>    
	</div></section> 
  
  <section class="slide shout"><div>
		<h2>Some Issues</h2>
	</div></section>
  
	<section class="slide"><div>
		<h2>Bloat</h2>
    <p>Not to pick on Handlebars as they've covered a lot of territory, but 
      Handlebars 2.0 is 98kb; 45kb compressed (14kb gzipped).</p>
    <p class='note'>(That, and the source is hard to read as it is generated by a build process.</p>
    <p>Download size can impact user experience (YMMV)</p>
    <p class='note'>
      Can be mitigated with smaller libraries (riot.js, absurdjs template, e.g.).
    </p>       
	</div></section>

	<section class="slide"><div>
		<h2>Non-executed Script Elements are a hack</h2>
    <p>(welcome to the web :).</p>
    <p class='note'>
      Can be mitigated by pre-compiling partials on the server into separate or
      combined JavaScript files.
    </p>    
	</div></section>
  
	<section class="slide"><div>
		<h2>Cool Parts Will Break</h2>
    <p>Uses the <code>Function ()</code> constructor to embed the text inside
      the partial function</p>
		<p>
      <mark>Content Security Policy</mark> in browsers prohibits 
      <code>eval()</code> and <code>Function()</code>
    </p>
    <p class='note'>
      Can be mitigated by pre-compiling partials on the server.
    </p>
	</div></section>

	<section class="slide"><div>
		<h2>Mixing Concerns between Model and View</h2>
    <p>Data is normally handled by a Model while rendering is normally handled 
      by a View.  Template engines tend to blur this separation.
    </p>
    <pre>
      <code>  {{#if items}}</code>
      <code>    {{#each items}}</code>
      <code>      &lt;li&gt;{{agree_button}}&lt;/li&gt;</code>
      <code>    {{/each}}</code>
      <code>  {{/if}}</code>
    </pre>
    
    <p class='note'>
      Can't mitigate that with pre-compiling or build processes.
    </p>
	</div></section>

	<section class="slide"><div>
		<h2>So, can we do better?</h2>
    <p class='next'>Maybe</p>
	</div></section>

	<section class="slide"><div>
		<h2>Strict separation of concerns</h2>
    <p>
      Terence Parr, (@the_antlr_guy) argues that templates are documents with 
      "holes" and should contain no business logic.
    </p>
		<figure>
			<blockquote>
				<p>
          A template should merely represent a view of a data set and be totally 
          divorced from the underlying data computations whose results it will 
          display.
        </p>
			</blockquote>
			<figcaption>Terence Parr, "Enforcing Strict Model-View Separation in 
        Template Engines", 
        <a href="http://www.cs.usfca.edu/~parrt/papers/mvc.templates.pdf">
          http://www.cs.usfca.edu/~parrt/papers/mvc.templates.pdf
        </a>
      </figcaption>
		</figure>  
	</div></section>
  
	<section class="slide"><div>
		<h2>StringTemplate ~ the original</h2>
    <p>
      Parr has implemented this strict separation in his own 
      <b>StringTemplate</b> project at <a href="http://www.stringtemplate.org/">
      http://www.stringtemplate.org/
      </a>, for java (with ports for C#, Python).
    </p>
    <p>Hence, &hellip;</p>
	</div></section>
  
	<section class="slide"><div>
		<h2>StringTemplate ~ a JavaScript version</h2>
    <p>Repo at github:
      <a href="https://github.com/dfkaye/stringtemplate">
        https://github.com/dfkaye/stringtemplate
      </a>
    </p>
    <p>Mocha suite on rawgit:
      <a href="https://rawgit.com/dfkaye/stringtemplate/master/test/mocha/browser-suite.html">
        https://rawgit.com/dfkaye/stringtemplate/master/test/mocha/browser-suite.html
      </a>
    </p>
	</div></section>
  
	<section class="slide"><div>
		<h2>Goals</h2>
		<ul>
      <li>one small file</li>
			<li>no dependencies</li>
			<li>no logic tokens</li>
			<li>no <code>Function()</code> constructor calls</li>
			<li>no custom types or <code>script</code> elements</li>
			<li>no formatting</li>
			<li>no error throwing</li>
		</ul>
	</div></section>
  
	<section class="slide"><div>
		<h2>API</h2>
    <p>A single method added to native <mark>String</mark> objects</p>
		<pre>
      <code>String.prototype.<mark>template<mark>(data, fn?)</code>    
    </pre>
		<pre>
      <code>var html = 'some html with <mark>$data$</mark>'.template(data);</code>    
    </pre>
	</div></section>
  
	<section class="slide"><div>
		<h2>Value tokens</h2>
    <p><mark>$</mark>value.identifier.which.may.be.nested<mark>$</mark></p>
    <pre>
      <code>var data = { name: 'johnny' };</code>
      <code>var string = '$name$';</code>
      <code>var name = string.template(data); // =&gt;  'johnny'</code>
    </pre>
	</div></section>
  
	<section class="slide"><div>
		<h2>By the way</h2>
    <p>
      If no tokens are found or data is not an actual non-null <mark>Object</mark>,
      then no transformation occurs.  The original string is returned.
    </p>
	</div></section>  
  
	<section class="slide"><div>
		<h2>Collection token set</h2>
    <p>denoted by start <mark>$name#$</mark> and end 
    <mark>$/name#$</mark>tags, each containing a trailing 
    <mark>#</mark>
    </p>
    <p>
      Accessing each element in the collection with <mark>$.$</mark> or 
      <mark>$.keyname$</mark>
    </p>
	</div></section>
  
	<section class="slide"><div>
		<h2>Example: Array of values</h2>
    <pre>
      <code>var data = { names: ['johnny', 'janie'] };</code>
      <code>var string = '&lt;ul&gt;$name<mark>#</mark>$ &lt;li&gt;$<mark>.</mark>$&lt;/li&gt; $<mark>/</mark>name<mark>#</mark>$&lt;/ul&gt;';</code>
      <code>var names = string.template(data);</code>
    </pre>
	</div></section>

	<section class="slide"><div>
		<h2>Example: Array of values, continued </h2>
    <pre>
      <code>Result:</code>
      <code>&lt;ul&gt; &lt;li&gt;<mark>johnny</mark>&lt;/li&gt; &lt;li&gt;<mark>janie</mark>&lt;/li&gt; &lt;/ul&gt;</code>
    </pre>
	</div></section>

	<section class="slide"><div>
		<h2>Example: Array of objects</h2>
    <pre>
      <code>var data = { who : [ </code>
      <code> { first: 'johnny', last: 'depp'},</code>
      <code> { first: 'denzel', last: 'washington'}</code>
      <code> ] };</code>
      <code>var string = ['&lt;ul&gt;$who<mark>#</mark>$',</code>
      <code> ' &lt;li&gt;$<mark>.last</mark>$, $<mark>.first</mark>$&lt;/li&gt; ',</code>
      <code> '$<mark>/</mark>who<mark>#</mark>$&lt;/ul&gt;'].join('\n');</code>
      <code>var who = string.template(data);</code>
    </pre>
	</div></section>
  
	<section class="slide"><div>
		<h2>Example: Array of objects, continued</h2>
    <pre>
      <code>Result:</code>
      <code>&lt;ul&gt;</code>
      <code>&lt;li&gt;<mark>depp</mark>, <mark>johnny</mark>&lt;/li&gt;</code>
      <code>&lt;li&gt;<mark>washington</mark>, <mark>denzel</mark>&lt;/li&gt;</code>
      <code>&lt;/ul&gt;</code>
    </pre>
	</div></section> 
  
  <section class="slide shout"><div>
		<h2>That was the easy part</h2>
	</div></section>
  
	<section class="slide"><div>
		<h2>Challenges</h2>
    <p>Many false starts (iterations) caused by</p>
    <ul>
      <li class="next">nested arrays required <mark>unambiguous</mark> syntax (groups vs. values)</li>
      <li class="next">sparse notation can be hard to read</li>
      <li class="next">TDD not always kind - a single method hides helper functions</li>
      <li class="next">Supporting a lot of cases (duplicate groups, 
        object-array-object-array) leads to <mark>bloat</mark>.</li>
      <li class="next">for-loop hell (sprawling); regex hell (brittle)</li>        
    </ul>
  </div></section>
  
	<section class="slide"><div>
		<h2>Challenges</h2>
    <p>Cannot support mixed data types</p>
    <ul>
      <li class="next">Arrays must contain single types of data (either all values or all 
      objects of a certain structure.</li>
      <li class="next"><code>[ 'a', 2, true ]</code> works</li>
      <li class="next"><code>[ {name: 'a' }, {name: 'b' }]</code> works</li>      
    </ul>
  </div></section>
  
	<section class="slide"><div>
		<h2>Challenges - mixed data - continued</h2>
    <ul>
      <li class="next"><code>[ 'a', {name: 'jed' } ]</code> with 
        &lt;li&gt;$.$&lt;/li&gt; produces <code>&lt;li&gt;a&lt;/li&gt; &lt;li&gt;<mark>[object Object]</mark>&lt;/li&gt;</code></li>
      <li class="next"><code>[ 'a', {name: 'jed' } ]</code> with 
        &lt;li&gt;$.name$&lt;/li&gt; produces <code>&lt;li&gt;<mark>undefined</mark>&lt;/li&gt; &lt;li&gt;jed&lt;/li&gt;</code></li>        
    </ul>
  </div></section>
  
	<section class="slide"><div>
		<h2>Challenges - continued</h2>
    <p>Large strings require a docstring helper, so I've added one, based on mstring 
      <a href="https://github.com/rjrodger/mstring">
      https://github.com/rjrodger/mstring
      </a> by Richard Rodger (@rjrodger):
    </p>
		<pre>
      <code>Function.prototype.<mark>template<mark>(data, fn?)</code>    
    </pre>
  </div></section>

  <section class="slide"><div>
    <h2>Function#template() example</h2>
    <p>Same signature as String#template. Calls String#template internally if a 
      data argument is provided; otherwise returns the docstring without 
      modification.
    </p>    
  </div></section>

	<section class="slide"><div>
		<h2>Function#template() example - continued</h2>
		<pre>
      <code>function fn() {</code>
      <code>/***</code>
      <code>This is a function template for $name$.</code>
      <code>***/</code>
      <code>fn.template({name: 'david'});</code>
      <code>// => 'This is a function template for <mark>david</mark>.'
    </pre>
  </div></section>
  
	<section class="slide"><div>
		<h2>Surprises</h2>
    <ul>
      <li class="next">This was a lot harder than anticipated - probably 100 iterations so far</li>    
      <li class="next">How-to-make-your-own is not covered in JavaScript resources</li>
      <li class="next">The transformed string being processed is the 
        <mark>state</mark> ~ never exposed until explicitly returned.</li>
      <li class="next">"error handling" without throwing means lots of 
        console output - error capturing argument to be added</li>
      <li class="next">Tried to avoid it but some recursion was required</li>
      <li class="next">&hellip; so far, able to avoid trees, visitors, etc. (no 
        custom types).</li>     
    </ul>
  </div></section>

	<section class="slide"><div>
		<h2>Surprises - continued</h2>
    <ul>
      <li>Function#template() mitigates the need for a "partial"</li>
      <li><code>template()</code> can be called without a data argument, 
        returning just the docstring</li>
      <li>store the docstring to a string variable and call <mark>template(data)</mark> 
        on that as needed.</li>
    </ul>
    <p>We'll see how that goes&hellip;</p>
  </div></section>
  
  <section class="slide"><div>
		<h2>Questions (or Suggestions)?</h2>
    <p class="next note">listing some that came up at the meetup</p>
    <ul class='next'>Not sure about strict separation (or at least @dfkaye's description of it):
      <li class='next'>View formats data, the model does not</li>
      <li class='next'>Template should support some hide/show if/else logic (not business logic)</li>
      <li class='next'>ah ~ the view !== the template, the view uses the template</li>
      <li class='next'>in other words ~ the view is its own MVC &amp; MVC is a fractal pattern</li>
    </ul>
	</div></section>

  <section class="slide"><div>
		<h2>Questions cont'd</h2>
    <ul>
      <li class='next'>Don't like the method on String.prototype (polluting libraries)</li>
      <li class='next'>yes ~ a constructor with methods would be easier but more bloated</li>
      <li class='next'>Don't modify objects you don't own</li>
      <li class='next'>ah ~ think that means "don't mutate objects that get passed around to other objects you don't own"</li>
      <li class='next'>Not sure about the block syntax (the collection token set)</li>
      <li class='next'>yep ~ work in progress</li>    
    </ul>
	</div></section>
  
  <section class="slide"><div>
		<h2>More to come.  Thank you for listening.</h2>
	</div></section>	
  
  <!--<p class="badge"><a href="https://github.com/shower/shower">Fork me on Github</a></p>-->
	<!--
		To hide progress bar from entire presentation
		just remove “progress” element.
		-->
	<div class="progress"><div></div></div>
	<script src="shower/shower.min.js"></script>
	<!-- Copyright © 2014 Yours Truly, Famous Inc. -->
	<!-- Photos by John Carey, fiftyfootshadows.net -->
</body>
</html>